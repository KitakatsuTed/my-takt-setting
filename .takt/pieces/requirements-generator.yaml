name: requirements-generator
description: 要件定義ドキュメント生成・品質レビュー・整合性チェック・修正を一貫実行
piece_config:
  provider_options:
    codex:
      network_access: true
    opencode:
      network_access: true
max_movements: 50
initial_movement: gather-info
interactive_mode: assistant

personas:
  planner: ../facets/personas/requirements-planner.md
  writer: ../facets/personas/requirements-writer.md
  checker: ../facets/personas/requirements-checker.md
  supervisor: ../facets/personas/requirements-supervisor.md

policies:
  requirements: ../facets/policies/requirements.md

knowledge:
  documents: ../facets/knowledge/requirements-documents.md
  consistency: ../facets/knowledge/consistency-patterns.md

movements:
  # Phase 1: プロジェクト情報の整理・生成計画
  - name: gather-info
    persona: planner
    policy: requirements
    knowledge: documents
    edit: false
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    instruction_template: |
      ユーザーのプロジェクト概要を分析し、要件定義ドキュメント生成に必要な情報を整理してください。

      **やること:**
      1. プロジェクト概要から以下を抽出する
         - プロジェクトの目的・背景
         - 対象ユーザー・ステークホルダー
         - 主要な機能・要件（推測を含む）
         - 技術的制約・前提条件
      2. 不足している情報を特定し、合理的な仮定を設定する
      3. 11種のドキュメント生成計画を作成する（生成順序・各ドキュメントの重点項目）
      4. ID体系（BRD-/REQ-/FUNC-/SCR-/NFR-/SEC-）を定義する

      **注意:** 質問しない。情報が不足していれば「仮定: ...」と明記して進める。

      **注意:** Previous Responseがある場合はsynthesizeからの差し戻し。
      フィードバックを反映した計画を修正してください。
    output_contracts:
      report:
        - name: 00-generation-plan.md
          format: |
            ```markdown
            # 要件定義ドキュメント生成計画

            ## プロジェクト概要（整理後）
            {プロジェクトの目的・背景・ユーザー・制約の要約}

            ## 仮定一覧
            | # | 項目 | 仮定内容 | 根拠 |
            |---|------|---------|------|
            | 1 | {項目} | {仮定} | {根拠} |

            ## ID体系
            | ドキュメント | プレフィックス | 例 |
            |------------|----------------|-----|
            | ビジネス要件 | BRD- | BRD-001 |

            ## 生成計画
            | Phase | ドキュメント | 生成順 | 重点項目 |
            |-------|------------|--------|---------|
            | Core | BRD, 業務フロー, 要求一覧 | 1 | {重点} |
            | Screens | 機能一覧, 画面一覧, 画面遷移図, ワイヤーフレーム | 2 | {重点} |
            | NFR | 非機能要件, セキュリティ要件, 合意書, スコープ+変更台帳 | 3 | {重点} |
            ```
    rules:
      - condition: 計画が完了した
        next: generate-core
      - condition: プロジェクト情報が全く不足しており計画を立てられない
        next: ABORT

  # Phase 2: コアドキュメント生成（BRD、業務フロー、要求一覧）
  - name: generate-core
    persona: writer
    policy: requirements
    knowledge: documents
    edit: true
    required_permission_mode: edit
    session: continue
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    instruction_template: |
      生成計画に基づいて、コアドキュメント（Phase 1）を生成してください。

      **参照する生成計画:**
      {report:00-generation-plan.md}

      **生成するドキュメント:**
      1. ビジネス要件定義書（BRD）
      2. 業務フロー図（As-Is / To-Be）
      3. 要求一覧

      **やること:**
      1. 生成計画の仮定とプロジェクト情報に基づいてドキュメントを生成する
      2. ID体系に従ってIDを付与する
      3. 業務フロー図はDraw.ioのMCPサーバーでフローチャートとして作成する
         - As-Is業務フローとTo-Be業務フローをそれぞれ作成
         - MCPツールの `drawio_create_diagram` を使用してdrawioファイルを生成
      4. 各ドキュメントをレポートディレクトリに出力する
      5. 不明な項目は「※要確認」を付けて仮の内容で埋める
    output_contracts:
      report:
        - name: 01-brd.md
          format: |
            ```markdown
            # ビジネス要件定義書（BRD）
            ## プロジェクトの目的・背景
            ## ビジネスゴール・KPI
            ## 対象ユーザー・ステークホルダー
            ## スコープ（対象範囲・対象外）
            ## 期待される効果
            ## 前提条件・制約条件
            ```
        - name: 02-business-flow.md
          format: |
            ```markdown
            # 業務フロー図
            ## As-Is（現状業務フロー）
            ※ Draw.ioのMCPサーバーでフローチャートを作成する
            ## 課題一覧
            ## To-Be（改善後業務フロー）
            ※ Draw.ioのMCPサーバーでフローチャートを作成する
            ## システム化対象範囲
            ## 業務ルール
            ```
        - name: 03-requirements-list.md
          format: |
            ```markdown
            # 要求一覧
            | 要求ID | 要求内容 | 要求元 | 優先度 | 対応方針 | 関連機能ID |
            |--------|---------|--------|--------|---------|-----------|
            | REQ-001 | {要求} | {要求元} | {優先度} | 採用 | FUNC-NNN |
            ```
    rules:
      - condition: コアドキュメントの生成が完了した
        next: generate-screens
      - condition: 生成を続行できない
        next: ABORT

  # Phase 3: 画面系ドキュメント生成
  - name: generate-screens
    persona: writer
    policy: requirements
    knowledge: documents
    edit: true
    required_permission_mode: edit
    session: continue
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    instruction_template: |
      コアドキュメントに基づいて、画面系ドキュメント（Phase 2）を生成してください。

      **参照するドキュメント:**
      - 生成計画: {report:00-generation-plan.md}
      - 要求一覧: {report:03-requirements-list.md}

      **生成するドキュメント:**
      1. 機能一覧
      2. 画面一覧
      3. 画面遷移図
      4. ワイヤーフレーム

      **やること:**
      1. 要求一覧のREQ-IDと機能一覧のFUNC-IDを対応付ける
      2. 機能一覧のFUNC-IDと画面一覧のSCR-IDを対応付ける
      3. 画面遷移図はDraw.ioのMCPサーバーで状態遷移図として作成する
         - MCPツールの `drawio_create_diagram` を使用してdrawioファイルを生成
      4. ワイヤーフレームは主要画面のみDraw.ioのMCPサーバーでUIモックアップとして作成する
         - MCPツールの `drawio_create_diagram` を使用してdrawioファイルを生成
    output_contracts:
      report:
        - name: 04-function-list.md
          format: |
            ```markdown
            # 機能一覧
            | 機能ID | 機能名 | 機能概要 | 優先度 | 関連要求ID | 関連画面ID |
            |--------|--------|---------|--------|-----------|-----------|
            | FUNC-001 | {名称} | {概要} | {優先度} | REQ-NNN | SCR-NNN |
            ```
        - name: 05-screen-list.md
          format: |
            ```markdown
            # 画面一覧
            | 画面ID | 画面名 | 画面種別 | 概要・用途 | 関連機能ID |
            |--------|--------|---------|-----------|-----------|
            | SCR-001 | {名称} | {種別} | {概要} | FUNC-NNN |
            ```
        - name: 06-screen-transition.md
          format: |
            ```markdown
            # 画面遷移図
            ※ Draw.ioのMCPサーバーで状態遷移図を作成する
            ## 遷移条件一覧
            | 遷移元 | 遷移先 | トリガー | 条件 |
            |--------|--------|---------|------|
            ```
        - name: 07-wireframes.md
          format: |
            ```markdown
            # ワイヤーフレーム
            ## {画面名}（SCR-NNN）
            ※ Draw.ioのMCPサーバーでUIモックアップを作成する
            ### UI要素
            | 要素 | 種別 | 説明 |
            |------|------|------|
            ```
    rules:
      - condition: 画面系ドキュメントの生成が完了した
        next: generate-nfr
      - condition: 生成を続行できない
        next: ABORT

  # Phase 4: 非機能要件系・管理系ドキュメント生成
  - name: generate-nfr
    persona: writer
    policy: requirements
    knowledge: documents
    edit: true
    required_permission_mode: edit
    session: continue
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    instruction_template: |
      これまでのドキュメントに基づいて、非機能要件系・管理系ドキュメント（Phase 3）を生成してください。

      **参照するドキュメント:**
      - 生成計画: {report:00-generation-plan.md}
      - BRD: {report:01-brd.md}
      - 機能一覧: {report:04-function-list.md}

      **生成するドキュメント:**
      1. 非機能要件定義書（IPA非機能要求グレード6大項目に準拠）
      2. セキュリティ要件定義書
      3. 要件合意書
      4. プロジェクトスコープ記述書 + 変更管理台帳

      **やること:**
      1. BRDのKPIから非機能要件の数値目標を導出する
      2. IPA非機能要求グレードの6大項目を網羅する
      3. セキュリティ要件はOWASP Top 10を参考にする
      4. 合意書はBRDとスコープの内容を参照する
    output_contracts:
      report:
        - name: 08-nfr.md
          format: |
            ```markdown
            # 非機能要件定義書
            ## 可用性
            ## 性能・拡張性
            ## 運用・保守性
            ## 移行性
            ## セキュリティ（概要）
            ## システム環境
            ```
        - name: 09-security.md
          format: |
            ```markdown
            # セキュリティ要件定義書
            ## 認証・認可方式
            ## データ暗号化方針
            ## アクセス制御
            ## 監査ログ
            ## 脆弱性対策
            ```
        - name: 10-agreement.md
          format: |
            ```markdown
            # 要件合意書
            ## 合意対象の要件範囲
            ## 前提条件
            ## 除外事項
            ## 変更手続き
            ## 合意者署名欄
            ```
        - name: 11-scope-and-change.md
          format: |
            ```markdown
            # プロジェクトスコープ記述書
            ## プロジェクトスコープ
            ## プロダクトスコープ
            ## 主要な成果物一覧
            ## 除外事項
            ## 制約条件・前提条件

            ---

            # 変更管理台帳
            | 変更要求ID | 変更内容 | 影響範囲 | 優先度 | 承認状況 | 対応日 |
            |-----------|---------|---------|--------|---------|--------|
            | CHG-001 | （初版のため変更なし） | - | - | - | - |
            ```
    rules:
      - condition: 全ドキュメントの生成が完了した
        next: reviewers
      - condition: 生成を続行できない
        next: ABORT

  # Phase 5: 品質レビュー（3観点並列）
  - name: reviewers
    parallel:
      - name: business-review
        persona: checker
        policy: requirements
        knowledge: documents
        edit: false
        pass_previous_response: false
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        instruction_template: |
          要件定義ドキュメントをビジネス価値の観点からレビューしてください。

          **レビュー対象ドキュメント:**
          - BRD: {report:01-brd.md}
          - 業務フロー: {report:02-business-flow.md}
          - 要求一覧: {report:03-requirements-list.md}
          - 機能一覧: {report:04-function-list.md}
          - 画面一覧: {report:05-screen-list.md}
          - 非機能要件: {report:08-nfr.md}
          - セキュリティ要件: {report:09-security.md}
          - 合意書: {report:10-agreement.md}
          - スコープ+変更台帳: {report:11-scope-and-change.md}

          **評価観点:**
          1. ビジネスゴールの明確さ・定量性（KPIが具体的か）
          2. ROIの現実性（期待効果が過大でないか）
          3. スコープの適切さ（広すぎ/狭すぎないか）
          4. ステークホルダーの網羅性（重要な関係者が漏れていないか）
          5. 市場・競合環境の考慮（外部環境が反映されているか）
          6. リスク対策の十分性（ビジネスリスクが考慮されているか）
        output_contracts:
          report:
            - name: review-business.md
              format: |
                ```markdown
                # ビジネス観点レビュー結果

                ## 総合評価: A / B / C / D

                ## 評価詳細
                | 評価項目 | 評価 | コメント |
                |---------|------|---------|
                | ゴールの明確さ | A-D | {コメント} |
                | KPIの定量性 | A-D | {コメント} |
                | スコープの適切さ | A-D | {コメント} |
                | ステークホルダー網羅性 | A-D | {コメント} |
                | リスク対策 | A-D | {コメント} |

                ## 主要な指摘事項
                | # | 重大度 | 指摘内容 | 改善提案 |
                |---|--------|---------|---------|
                | 1 | {H/M/L} | {指摘} | {提案} |
                ```
        rules:
          - condition: レビュー完了
          - condition: レビュー不可能

      - name: ux-review
        persona: checker
        policy: requirements
        knowledge: documents
        edit: false
        pass_previous_response: false
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        instruction_template: |
          要件定義ドキュメントをユーザー体験の観点からレビューしてください。

          **レビュー対象ドキュメント:**
          - BRD: {report:01-brd.md}
          - 業務フロー: {report:02-business-flow.md}
          - 要求一覧: {report:03-requirements-list.md}
          - 機能一覧: {report:04-function-list.md}
          - 画面一覧: {report:05-screen-list.md}
          - 画面遷移図: {report:06-screen-transition.md}
          - ワイヤーフレーム: {report:07-wireframes.md}

          **評価観点:**
          1. 業務フローの効率性（To-Beで本当に改善されるか）
          2. 画面遷移の自然さ（ユーザーが迷わないか）
          3. ワイヤーフレームの使いやすさ（直感的に操作できるか）
          4. ユーザーペルソナの適切さ（対象ユーザーが明確か）
          5. エラーケースの考慮（異常系が想定されているか）
          6. アクセシビリティの考慮（多様なユーザーへの配慮）
        output_contracts:
          report:
            - name: review-ux.md
              format: |
                ```markdown
                # UX観点レビュー結果

                ## 総合評価: A / B / C / D

                ## 評価詳細
                | 評価項目 | 評価 | コメント |
                |---------|------|---------|
                | 業務フローの効率性 | A-D | {コメント} |
                | 画面遷移の自然さ | A-D | {コメント} |
                | UIの使いやすさ | A-D | {コメント} |
                | エラーケースの考慮 | A-D | {コメント} |
                | アクセシビリティ | A-D | {コメント} |

                ## 主要な指摘事項
                | # | 重大度 | 指摘内容 | 改善提案 |
                |---|--------|---------|---------|
                | 1 | {H/M/L} | {指摘} | {提案} |
                ```
        rules:
          - condition: レビュー完了
          - condition: レビュー不可能

      - name: tech-review
        persona: checker
        policy: requirements
        knowledge: documents
        edit: false
        pass_previous_response: false
        allowed_tools:
          - Read
          - Glob
          - Grep
          - WebSearch
          - WebFetch
        instruction_template: |
          要件定義ドキュメントを技術実現性の観点からレビューしてください。

          **レビュー対象ドキュメント:**
          - BRD: {report:01-brd.md}
          - 要求一覧: {report:03-requirements-list.md}
          - 機能一覧: {report:04-function-list.md}
          - 画面一覧: {report:05-screen-list.md}
          - 非機能要件: {report:08-nfr.md}
          - セキュリティ要件: {report:09-security.md}

          **評価観点:**
          1. 技術的実現可能性（現在の技術で実現できるか）
          2. 非機能要件の現実性（性能目標が現実的か）
          3. セキュリティ要件の十分性（OWASP Top 10をカバーしているか）
          4. インフラ構成の適切さ（可用性目標に合致するか）
          5. 開発規模の見積もり妥当性（チーム規模・期間に対して適切か）
          6. 技術的リスクの特定（新技術導入、データ移行等）
        output_contracts:
          report:
            - name: review-tech.md
              format: |
                ```markdown
                # 技術観点レビュー結果

                ## 総合評価: A / B / C / D

                ## 評価詳細
                | 評価項目 | 評価 | コメント |
                |---------|------|---------|
                | 技術的実現可能性 | A-D | {コメント} |
                | 非機能要件の現実性 | A-D | {コメント} |
                | セキュリティ要件の十分性 | A-D | {コメント} |
                | インフラ構成の適切さ | A-D | {コメント} |
                | 開発規模の妥当性 | A-D | {コメント} |
                | 技術的リスク | A-D | {コメント} |

                ## 主要な指摘事項
                | # | 重大度 | 指摘内容 | 改善提案 |
                |---|--------|---------|---------|
                | 1 | {H/M/L} | {指摘} | {提案} |
                ```
        rules:
          - condition: レビュー完了
          - condition: レビュー不可能

    rules:
      - condition: any("レビュー完了")
        next: checkers

  # Phase 6: 整合性チェック（4観点並列）
  - name: checkers
    parallel:
      - name: id-consistency-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        pass_previous_response: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメント間のID参照整合性をチェックしてください。

          **チェック対象ドキュメント:**
          - 生成計画: {report:00-generation-plan.md}
          - BRD: {report:01-brd.md}
          - 業務フロー: {report:02-business-flow.md}
          - 要求一覧: {report:03-requirements-list.md}
          - 機能一覧: {report:04-function-list.md}
          - 画面一覧: {report:05-screen-list.md}
          - 画面遷移図: {report:06-screen-transition.md}
          - ワイヤーフレーム: {report:07-wireframes.md}
          - 非機能要件: {report:08-nfr.md}
          - セキュリティ要件: {report:09-security.md}
          - 合意書: {report:10-agreement.md}
          - スコープ+変更台帳: {report:11-scope-and-change.md}

          **やること:**
          1. 各ドキュメントからIDを抽出する（REQ-/FUNC-/SCR-/NFR-/SEC-等）
          2. ID間の参照関係を検証する（要求ID→機能ID→画面ID）
          3. 存在しないIDへの参照（ダングリング参照）を検出する
          4. 参照されていないID（孤立ID）を検出する
        output_contracts:
          report:
            - name: check-id.md
              format: |
                ```markdown
                # ID参照整合性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## 検出された問題
                | # | 重大度 | 種別 | ドキュメント | 該当ID | 問題 |
                |---|--------|------|------------|--------|------|
                | 1 | High | ダングリング参照 | {doc} | {id} | {説明} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

      - name: coverage-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        pass_previous_response: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメントの網羅性・トレーサビリティをチェックしてください。

          **チェック対象ドキュメント:**
          - 生成計画: {report:00-generation-plan.md}
          - BRD: {report:01-brd.md}
          - 要求一覧: {report:03-requirements-list.md}
          - 機能一覧: {report:04-function-list.md}
          - 画面一覧: {report:05-screen-list.md}
          - 非機能要件: {report:08-nfr.md}

          **やること:**
          1. BRDのビジネスゴール → 要求一覧 → 機能一覧のトレースチェック
          2. 機能一覧 → 画面一覧の対応チェック
          3. 非機能要件のIPA6大項目の網羅性チェック
          4. カバーされていない要件の洗い出し
        output_contracts:
          report:
            - name: check-coverage.md
              format: |
                ```markdown
                # 網羅性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## トレーサビリティ
                | 上流 | 下流 | カバー率 | 未対応項目 |
                |------|------|---------|-----------|
                | BRD目標 | 機能一覧 | {%} | {未対応ID} |

                ## 検出された漏れ
                | # | 重大度 | 種別 | 内容 |
                |---|--------|------|------|
                | 1 | High | 要件漏れ | {説明} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

      - name: terminology-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        pass_previous_response: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメント間の用語一貫性をチェックしてください。

          **チェック対象ドキュメント:**
          - BRD: {report:01-brd.md}
          - 業務フロー: {report:02-business-flow.md}
          - 要求一覧: {report:03-requirements-list.md}
          - 機能一覧: {report:04-function-list.md}
          - 画面一覧: {report:05-screen-list.md}
          - 非機能要件: {report:08-nfr.md}
          - セキュリティ要件: {report:09-security.md}

          **やること:**
          1. ドキュメント横断で使用されている主要な用語を抽出する
          2. 同じ概念に異なる名称が使われている箇所を検出する（名称揺れ）
          3. 定義が曖昧または未定義の業務用語を検出する
          4. 機能名・画面名の一貫性をチェックする
        output_contracts:
          report:
            - name: check-terminology.md
              format: |
                ```markdown
                # 用語一貫性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## 検出された用語の不一致
                | # | 重大度 | 用語A | 用語B | 出現箇所 | 推奨統一名 |
                |---|--------|-------|-------|---------|-----------|
                | 1 | Medium | {用語A} | {用語B} | {箇所} | {推奨} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

      - name: semantic-consistency-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        pass_previous_response: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメント間の意味的な矛盾をチェックしてください。

          **チェック対象ドキュメント:**
          - BRD: {report:01-brd.md}
          - 要求一覧: {report:03-requirements-list.md}
          - 機能一覧: {report:04-function-list.md}
          - 画面一覧: {report:05-screen-list.md}
          - 非機能要件: {report:08-nfr.md}
          - セキュリティ要件: {report:09-security.md}
          - 合意書: {report:10-agreement.md}
          - スコープ+変更台帳: {report:11-scope-and-change.md}

          **やること:**
          1. BRDとスコープ記述書の整合性チェック（必須機能がスコープ外にないか）
          2. BRDと非機能要件の整合性チェック（KPIと性能目標の整合性）
          3. セキュリティ要件と機能の整合性チェック（個人情報の取り扱い等）
          4. 画面遷移図と機能一覧の整合性チェック
          5. 図表と本文記述の整合性チェック
        output_contracts:
          report:
            - name: check-semantic.md
              format: |
                ```markdown
                # 意味的整合性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## 検出された矛盾
                | # | 重大度 | ドキュメントA | 記述A | ドキュメントB | 記述B | 矛盾の内容 |
                |---|--------|-------------|-------|-------------|-------|-----------|
                | 1 | High | {docA} | {引用A} | {docB} | {引用B} | {説明} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

    rules:
      - condition: any("チェック完了")
        next: synthesize

  # Phase 7: 統合判定（レビュー＋チェック結果を統合）
  - name: synthesize
    persona: supervisor
    policy: requirements
    knowledge:
      - documents
      - consistency
    edit: false
    pass_previous_response: false
    allowed_tools:
      - Read
      - Glob
      - Grep
    instruction_template: |
      品質レビュー（3観点）と整合性チェック（4観点）の全結果を統合し、
      品質判定レポートを作成してください。

      **現在のイテレーション:** {iteration}回目（ピース全体）

      **レビュー結果:**
      - ビジネス観点: {report:review-business.md}
      - UX観点: {report:review-ux.md}
      - 技術観点: {report:review-tech.md}

      **チェック結果:**
      - ID参照整合性: {report:check-id.md}
      - 網羅性: {report:check-coverage.md}
      - 用語一貫性: {report:check-terminology.md}
      - 意味的整合性: {report:check-semantic.md}

      **やること:**
      1. 7つの結果を重大度順に統合する
      2. High問題の件数を集計する
      3. High問題がある場合: 修正対象のドキュメントと修正内容を具体的に指示する
      4. 修正の優先順位を提示する

      **判定基準:**
      - High問題が0件 → 「合格」と判定
      - High問題が1件以上 → 「要修正」と判定し、具体的な修正指示を記載

      **ループ上限の判断:**
      - レビュー・チェック・修正のループが上限（ピース全体で約10回目のレビューサイクル）に
        達したと判断される場合は、残存するHigh問題を一覧で報告し「上限到達」と判定する
    output_contracts:
      report:
        - name: quality-report.md
          format: |
            ```markdown
            # 品質判定レポート

            ## 判定: 合格 / 要修正 / 上限到達

            ## サマリー
            {2-3文で全結果を統合要約}

            ## レビュー結果一覧
            | レビュー観点 | 評価 | 主要な発見 |
            |------------|------|-----------|
            | ビジネス | A-D | {概要} |
            | UX | A-D | {概要} |
            | 技術 | A-D | {概要} |

            ## チェック結果一覧
            | チェック種別 | 結果 | 問題数 | High | Medium | Low |
            |------------|------|--------|------|--------|-----|
            | ID参照整合性 | OK/問題あり | {N} | {n} | {n} | {n} |
            | 網羅性 | OK/問題あり | {N} | {n} | {n} | {n} |
            | 用語一貫性 | OK/問題あり | {N} | {n} | {n} | {n} |
            | 意味的整合性 | OK/問題あり | {N} | {n} | {n} | {n} |

            ## High問題一覧
            | # | 観点/種別 | 問題 | 対象ドキュメント | 修正指示 |
            |---|----------|------|----------------|---------|
            | 1 | {観点} | {問題} | {ファイル名} | {具体的な修正内容} |

            ## Medium問題一覧
            | # | 観点/種別 | 問題 | 推奨アクション |
            |---|----------|------|--------------|
            | 1 | {観点} | {問題} | {アクション} |

            ## Low問題一覧
            | # | 観点/種別 | 問題 |
            |---|----------|------|
            | 1 | {観点} | {問題} |

            ## 改善提案（優先度順）
            1. {最優先の改善提案}
            2. {次の改善提案}
            ```
    rules:
      - condition: High問題が0件で合格と判定した
        next: COMPLETE
      - condition: High問題があるが上限に到達した
        next: COMPLETE
      - condition: High問題があり修正が必要
        next: fix
      - condition: 計画レベルの根本的な見直しが必要
        next: gather-info

  # Phase 8: ドキュメント修正
  - name: fix
    persona: writer
    policy: requirements
    knowledge: documents
    edit: true
    required_permission_mode: edit
    session: continue
    pass_previous_response: false
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
    instruction_template: |
      品質判定レポートのHigh問題に基づいて、対象ドキュメントを修正してください。

      **品質判定レポート:**
      {report:quality-report.md}

      **やること:**
      1. quality-report.md の「High問題一覧」を確認する
      2. 各High問題の「修正指示」に従って対象ドキュメントを修正する
      3. 修正時はID体系の整合性を維持する
      4. 修正したドキュメントをレポートディレクトリに上書き保存する

      **注意:**
      - High問題のみ修正する（Medium/Lowは対象外）
      - 修正により新たな矛盾が生じないよう、関連ドキュメントも確認する
      - 修正内容は「※修正済み」と注記しない（クリーンな状態を維持する）
    rules:
      - condition: 修正が完了した
        next: reviewers
      - condition: 修正を続行できない
        next: ABORT
