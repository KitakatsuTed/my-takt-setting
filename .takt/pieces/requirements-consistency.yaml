name: requirements-consistency
description: 要件定義整合性チェック - ドキュメント間の矛盾・漏れを並列検出
piece_config:
  provider_options:
    codex:
      network_access: true
    opencode:
      network_access: true
max_movements: 10
initial_movement: gather
interactive_mode: assistant

personas:
  planner: ../facets/personas/requirements-planner.md
  checker: ../facets/personas/requirements-checker.md
  supervisor: ../facets/personas/requirements-supervisor.md

policies:
  requirements: ../facets/policies/requirements.md

knowledge:
  documents: ../facets/knowledge/requirements-documents.md
  consistency: ../facets/knowledge/consistency-patterns.md

movements:
  # Step 1: ドキュメント収集・構造把握
  - name: gather
    persona: planner
    policy: requirements
    knowledge: documents
    edit: false
    allowed_tools:
      - Read
      - Glob
      - Grep
    instruction_template: |
      要件定義ドキュメント群の構造を把握し、整合性チェックの準備をしてください。

      **やること:**
      1. 指定されたディレクトリまたはファイルから要件定義ドキュメントを特定する
      2. 各ドキュメントの種類を識別する（BRD/業務フロー/要求一覧/機能一覧/画面一覧/画面遷移図/ワイヤーフレーム/非機能要件/セキュリティ要件/合意書/スコープ記述書）
      3. 使用されているID体系を特定する
      4. チェック対象の概要をまとめる

      **注意:** 質問しない。ドキュメントが見つかった範囲で進める。
    output_contracts:
      report:
        - name: 00-check-target.md
          format: |
            ```markdown
            # 整合性チェック対象

            ## ドキュメント一覧
            | # | ドキュメント種別 | ファイル | 識別されたID体系 |
            |---|----------------|---------|----------------|
            | 1 | {種別} | {パス} | {ID体系} |

            ## ID体系
            {検出されたIDプレフィックスと使用パターン}

            ## チェック準備状況
            | チェック種別 | 実行可否 | 理由 |
            |------------|---------|------|
            | ID参照整合性 | 可/不可 | {理由} |
            | 網羅性 | 可/不可 | {理由} |
            | 用語一貫性 | 可/不可 | {理由} |
            | 意味的矛盾 | 可/不可 | {理由} |
            ```
    rules:
      - condition: チェック対象の情報収集完了
        next: checkers
      - condition: ドキュメントが見つからない、チェック不可能
        next: ABORT

  # Step 2: 4観点並列チェック
  - name: checkers
    parallel:
      - name: id-consistency-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメント間のID参照整合性をチェックしてください。

          **チェック対象情報:**
          {report:00-check-target.md}

          **やること:**
          1. 各ドキュメントからIDを抽出する（REQ-/FUNC-/SCR-/NFR-/SEC-等）
          2. ID間の参照関係を検証する（要求ID→機能ID→画面ID）
          3. 存在しないIDへの参照（ダングリング参照）を検出する
          4. 参照されていないID（孤立ID）を検出する
        output_contracts:
          report:
            - name: 01-id-check.md
              format: |
                ```markdown
                # ID参照整合性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## 検出された問題
                | # | 重大度 | 種別 | ドキュメント | 該当ID | 問題 |
                |---|--------|------|------------|--------|------|
                | 1 | High | ダングリング参照 | {doc} | {id} | {説明} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

      - name: coverage-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメントの網羅性・トレーサビリティをチェックしてください。

          **チェック対象情報:**
          {report:00-check-target.md}

          **やること:**
          1. BRDのビジネスゴール → 要求一覧 → 機能一覧のトレースチェック
          2. 機能一覧 → 画面一覧の対応チェック
          3. 非機能要件のIPA6大項目の網羅性チェック
          4. カバーされていない要件の洗い出し
        output_contracts:
          report:
            - name: 02-coverage-check.md
              format: |
                ```markdown
                # 網羅性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## トレーサビリティ
                | 上流 | 下流 | カバー率 | 未対応項目 |
                |------|------|---------|-----------|
                | BRD目標 | 機能一覧 | {%} | {未対応ID} |

                ## 検出された漏れ
                | # | 重大度 | 種別 | 内容 |
                |---|--------|------|------|
                | 1 | High | 要件漏れ | {説明} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

      - name: terminology-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメント間の用語一貫性をチェックしてください。

          **チェック対象情報:**
          {report:00-check-target.md}

          **やること:**
          1. ドキュメント横断で使用されている主要な用語を抽出する
          2. 同じ概念に異なる名称が使われている箇所を検出する（名称揺れ）
          3. 定義が曖昧または未定義の業務用語を検出する
          4. 機能名・画面名の一貫性をチェックする
        output_contracts:
          report:
            - name: 03-terminology-check.md
              format: |
                ```markdown
                # 用語一貫性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## 検出された用語の不一致
                | # | 重大度 | 用語A | 用語B | 出現箇所 | 推奨統一名 |
                |---|--------|-------|-------|---------|-----------|
                | 1 | Medium | {用語A} | {用語B} | {箇所} | {推奨} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

      - name: semantic-consistency-check
        persona: checker
        policy: requirements
        knowledge: consistency
        edit: false
        allowed_tools:
          - Read
          - Glob
          - Grep
        instruction_template: |
          要件定義ドキュメント間の意味的な矛盾をチェックしてください。

          **チェック対象情報:**
          {report:00-check-target.md}

          **やること:**
          1. BRDとスコープ記述書の整合性チェック（必須機能がスコープ外にないか）
          2. BRDと非機能要件の整合性チェック（KPIと性能目標の整合性）
          3. セキュリティ要件と機能の整合性チェック（個人情報の取り扱い等）
          4. 画面遷移図と機能一覧の整合性チェック
          5. 図表と本文記述の整合性チェック
        output_contracts:
          report:
            - name: 04-semantic-check.md
              format: |
                ```markdown
                # 意味的整合性チェック結果

                ## 結果: OK / 問題あり

                ## サマリー
                {1-2文で結果を要約}

                ## 検出された矛盾
                | # | 重大度 | ドキュメントA | 記述A | ドキュメントB | 記述B | 矛盾の内容 |
                |---|--------|-------------|-------|-------------|-------|-----------|
                | 1 | High | {docA} | {引用A} | {docB} | {引用B} | {説明} |
                ```
        rules:
          - condition: チェック完了
          - condition: チェック不可能

    rules:
      - condition: any("チェック完了")
        next: synthesize

  # Step 3: チェック結果統合
  - name: synthesize
    persona: supervisor
    policy: requirements
    knowledge: consistency
    edit: false
    allowed_tools:
      - Read
      - Glob
      - Grep
    pass_previous_response: false
    instruction_template: |
      4つの整合性チェック結果を統合し、最終レポートを作成してください。

      **やること:**
      1. Report Directory内の全チェックレポートを読む
         - `00-check-target.md`（チェック対象情報）
         - `01-id-check.md`（ID参照整合性）
         - `02-coverage-check.md`（網羅性）
         - `03-terminology-check.md`（用語一貫性）
         - `04-semantic-check.md`（意味的整合性）
      2. 全チェック結果を重大度順に統合する
      3. 修正の優先順位を提示する
      4. ドキュメント改善の具体的な推奨アクションを提示する
    output_contracts:
      report:
        - name: consistency-report.md
          format: |
            ```markdown
            # 要件定義整合性チェック総合レポート

            ## 総合判定: OK / 要修正

            ## サマリー
            {2-3文で全チェック結果を要約}

            ## チェック結果一覧
            | チェック種別 | 結果 | 問題数 | High | Medium | Low |
            |------------|------|--------|------|--------|-----|
            | ID参照整合性 | OK/問題あり | {N} | {n} | {n} | {n} |
            | 網羅性 | OK/問題あり | {N} | {n} | {n} | {n} |
            | 用語一貫性 | OK/問題あり | {N} | {n} | {n} | {n} |
            | 意味的整合性 | OK/問題あり | {N} | {n} | {n} | {n} |

            ## 重大な問題（High）
            | # | チェック種別 | 問題 | 影響範囲 | 推奨アクション |
            |---|------------|------|---------|--------------|
            | 1 | {種別} | {問題} | {影響} | {アクション} |

            ## 中程度の問題（Medium）
            | # | チェック種別 | 問題 | 推奨アクション |
            |---|------------|------|--------------|
            | 1 | {種別} | {問題} | {アクション} |

            ## 軽微な問題（Low）
            | # | チェック種別 | 問題 |
            |---|------------|------|
            | 1 | {種別} | {問題} |

            ## 修正優先順位
            1. {最優先で修正すべき項目}
            2. {次に修正すべき項目}

            ## 改善推奨
            - {全体的な改善提案}
            ```
    rules:
      - condition: 統合レポートの作成完了
        next: COMPLETE
